<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <link rel="stylesheet" href="shop.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        
    </style>
</head>
<body>

    <canvas class="webgl"></canvas>

    <div class="sprite Photographe">
        <a href="metier.php?id=1" class="plus">+</a>
        <div class="nom">Cadreur-Monteur</div>
    </div>

    <div class="sprite Cadreur">
        <a href="metier.php?id=2" class="plus">+</a>
        <div class="nom">Photographe</div>
    </div>

    <div class="sprite Manager">
        <a href="metier.php?id=1" class="plus">+</a>
        <div class="nom">Manager</div>
    </div>

    <div class="sprite Développeur">
        <a href="metier.php?id=1" class="plus">+</a>
        <div class="nom">Développeur</div>
    </div>

    <script src="js/three.min.js"></script>
    <script src="js/GLTFLoader.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/three.interactive.js"></script>
    <script src="js/tween.umd.js"></script>
    <script>
        //Setup
        const canvas = document.querySelector('canvas.webgl')
        const WIDTH = window.innerWidth
        const HEIGHT = window.innerHeight
        const scene = new THREE.Scene()
        const camera = new THREE.PerspectiveCamera(80, WIDTH / HEIGHT, 0.1, 1000)
        camera.position.y = 4
        camera.position.z = 4
        camera.rotation.x = -Math.PI/4

        const light = new THREE.HemisphereLight( 0xffffff, 0xffffff , 5 )
        light.position.set( 0, 1, 0 )
        scene.add( light )
        const renderer = new THREE.WebGLRenderer({canvas: canvas, antialias: true})
        renderer.setSize(WIDTH, HEIGHT)
        renderer.setClearColor(0xCCE7FF)
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))

        //Resize
        window.addEventListener('resize', () => {
            const WIDTH = window.innerWidth
            const HEIGHT = window.innerHeight

            camera.aspect = WIDTH / HEIGHT
            camera.updateProjectionMatrix()

            renderer.setSize(WIDTH, HEIGHT)
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2))
        })

        //Decor
        const decorgeometry = new THREE.PlaneGeometry( 20, 20, 1 )
        const decormaterial = new THREE.MeshBasicMaterial( {color: 0xCCE7FF, side: THREE.DoubleSide} )
        const decor = new THREE.Mesh( decorgeometry, decormaterial )
        decor.rotation.x = Math.PI/2
        scene.add( decor )


        //Characters

        const loader = new THREE.GLTFLoader()

        function modelLoader(src) {
            return new Promise((resolve, reject) => {
                loader.load(src, data => resolve(data), null, reject)
            })
        }
        
        async function createCharacter({name, src, url, x, y, z, g}) {
            const gltf = await modelLoader(src)

            model = gltf.scene.children[0]
            model.position.set(x,y,z)
            model.rotation.z = g
            model.scale.multiplyScalar(0.2)
            scene.add(model)

            interactionManager.add(model)

            model.addEventListener("click", () =>{
                window.location.href = `${url}`
            })

            model.addEventListener("mouseover", () => {
                document.body.style.cursor = "pointer"
                document.querySelector(`.${name}`).classList.add("active")                         
                })

            model.addEventListener("mouseout", () => {
                document.body.style.cursor = "auto"
                document.querySelector(`.${name}`).classList.remove("active")        

                
                })

            return model
        }


        // Data

        const characters = {
            Photographe: createCharacter({ name: 'Photographe', src: 'gltf/characters/perso/scene.gltf', url:'metier.php?id=1', x: -4, y: 1, z: -4, g:1 }),
            Cadreur: createCharacter({ name: 'Cadreur', src: 'gltf/characters/perso/scene.gltf', url:'metier.php?id=2', x: 1, y: 1, z: -4, g:-1 }),
            Manager: createCharacter({ name: 'Manager', src: 'gltf/characters/perso/scene.gltf', url:'metier.php?id=1', x: 2, y: 1, z: 2, g:0 }),
            Développeur: createCharacter({ name: 'Développeur', src: 'gltf/characters/perso/scene.gltf', url:'metier.php?id=1', x: -1, y: 1, z: 1, g:1 })
        }

        const sprites = [
            { position: new THREE.Vector3(-4+.2, 1+1.2, -4), element: document.querySelector('.Photographe') },
            { position: new THREE.Vector3(1+.2, 1+1.2, -4), element: document.querySelector('.Cadreur') },
            { position: new THREE.Vector3(2+.2, 1+1.2, 2), element: document.querySelector('.Manager') },
            { position: new THREE.Vector3(-1+.2, 1+1.2, 1), element: document.querySelector('.Développeur') }
        ]


       //Interactions
        interactionManager = new THREE.InteractionManager(renderer, camera, canvas)


        //Controls
        const controls = new THREE.MapControls(camera, canvas)
        controls.enableDamping = true
        controls.enableZoom = false
        controls.enableRotate = false

        //Limit Pan
        const minPan = new THREE.Vector3( -4 , - 4, - 4 )
        const maxPan = new THREE.Vector3( 4, 4, 4 )
        const v = new THREE.Vector3()        
        controls.addEventListener("change", function() {
            v.copy(controls.target)
            controls.target.clamp(minPan, maxPan)
            v.sub(controls.target)
            camera.position.sub(v)
        })
        
        //Loop
        function Animate(time) {
            
            controls.update()
            interactionManager.update()
            TWEEN.update(time)

            //Sprites
            for (const sprite of sprites){
                const screenPosition = sprite.position.clone()
                screenPosition.project(camera)

                const translateX = screenPosition.x * window.innerWidth *0.5
                const translateY = -screenPosition.y * window.innerHeight *0.5
                sprite.element.style.transform = `translate(${translateX}px,${translateY}px)`

            }
            renderer.render(scene, camera)

            requestAnimationFrame(Animate)
        }

        //Init
        function Init() {
        Animate()
        }

        //Load
        window.addEventListener('load', Init, false)


    </script>
    
</body>
</html>